<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css">
  <title>Hyrox Calculator</title>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-94KG4CVG5D"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-94KG4CVG5D');
  </script>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Hyrox Calculator</h1>
      <p class="lead">Sliders estimate your event time. Each split shows the <em>topâ€‘100 average</em>.</p>
      <p></p>
      <p class="lead">(<em>Total estimated time does not include Roxzone time</em>)</p>
    </div>
  </header>

  <main class="wrap">
    <section id="totals" class="panel hidden">
      <div class="total">
        <span>Total Estimated Time</span>
        <span id="totalTime">0:00</span>
      </div>
    </section>

    <section id="splits" class="grid hidden"></section>

    <footer>
      <a href="https://www.instagram.com/olimpieciogimnastikos">Let's roll the ball!</a>
    </footer>
  </main>

  <script>
    const DEFAULT_REMOTE = "https://hyrox.top/contrib/top.json";

    // --- Utilities ---
    function secondsToHMS(sec) {
      if (sec == null || isNaN(sec)) return "";
      sec = Math.round(sec);
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = sec % 60;
      return h > 0 ? `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`
                   : `${m}:${String(s).padStart(2,'0')}`;
    }
    function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }
    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }
    function showApp() {
      document.getElementById('totals').classList.remove('hidden');
      document.getElementById('splits').classList.remove('hidden');
    }

    // --- State ---
    let sliders = []; // [{split, inputEl, valueEl, avgSec, count}]

    function clearUI() {
      document.getElementById('splits').innerHTML = "";
      document.getElementById('totalTime').textContent = "0:00";
      sliders = [];
    }

    function buildFromData(data) {
      clearUI();
      const splits = data?.aggregate?.splits || data?.splits || [];
      if (!Array.isArray(splits) || splits.length === 0) {
        console.warn("No splits found in JSON (expected payload.aggregate.splits[])");
        return;
      }
      const grid = document.getElementById('splits');
      splits.forEach((row, idx) => {
        const splitName = row.split || `Split ${idx+1}`;
        const avgSec = Number(row.mean_average_seconds ?? row.avg_seconds ?? row.average_seconds);
        const avgLabel = secondsToHMS(avgSec);
        const count = row.count ?? null;

        const min = 0;
        const max = Math.max(60, Math.round((avgSec || 60) * 2.5));
        const start = clamp(Math.round(avgSec || 60), min, max);

        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="split-title">
            <div class="split-name">${splitName}</div>
            <div class="avg">Avg: <strong>${avgLabel || "n/a"}</strong></div>
          </div>
          <div class="slider-row">
            <input type="range" min="${min}" max="${max}" value="${start}" step="1" aria-label="${splitName} slider">
            <div class="value" aria-live="polite">${secondsToHMS(start)}</div>
          </div>
        `;
        const inputEl = card.querySelector('input[type="range"]');
        const valueEl = card.querySelector('.value');
        inputEl.addEventListener('input', () => {
          valueEl.textContent = secondsToHMS(Number(inputEl.value));
          updateTotal();
        });

        grid.appendChild(card);
        sliders.push({ split: splitName, inputEl, valueEl, avgSec: avgSec || 0, count: count || 0 });
      });
      updateTotal();
      showApp();
    }

    function updateTotal() {
      const total = sliders.reduce((sum, s) => sum + Number(s.inputEl.value || 0), 0);
      document.getElementById('totalTime').textContent = secondsToHMS(total);
    }

    (async function boot() {
      try {
        const res = await fetch(DEFAULT_REMOTE, { cache: 'no-store' });
        if (res.ok) {
          const payload = await res.json();
          buildFromData(payload);
          return;
        }
      } catch (e) {
        console.warn("Default remote fetch failed:", e);
      }

      // If nothing above worked, leave controls visible for manual loading
      document.getElementById('loaderPanel').classList.remove('hidden');
    })();
  </script>
</body>
</html>
